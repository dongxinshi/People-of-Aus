<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Document</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet-src.js"></script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.11.2/css/all.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>


<style>
@-webkit-keyframes spinner-border {
  to {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}

@keyframes spinner-border {
  to {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}

.spinner-border {
  display: inline-block;
  width: 2rem;
  height: 2rem;
  vertical-align: -0.125em;
  border: 0.25em solid currentColor;
  border-right-color: transparent;
  border-radius: 50%;
  -webkit-animation: .75s linear infinite spinner-border;
  animation: .75s linear infinite spinner-border;
}

.spinner-border-sm {
  width: 1rem;
  height: 1rem;
  border-width: 0.2em;
}
	
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
}
	
.spinner-border {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: -0.125em;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    -webkit-animation: .75s linear infinite spinner-border;
    animation: .75s linear infinite spinner-border;
}
.entry-content a {
    text-decoration: none;
}
.dropdown-menu.show {
    right: 0;
    display: inline-block;
}
	
.entry-content h1, .entry-content h2, .entry-content h3, .entry-content h4, .entry-content h5, .entry-content h6 {
    margin-bottom: 20px;
    line-height: 1.3;
    font-weight: 700;
    margin-top: auto;
}
	
.entry-header .entry-title {
    margin-bottom: -50px;
    margin-top: 0;
}
	
.form-control {
    left: 100px;
    display: block;
    width: 100%;
    height: calc(1.5em + 0.75rem + 2px);
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
}

.row {display: flex;flex-wrap: wrap;margin-right: -15px;margin-left:  -15px;}

.mt-2, .my-2 {margin-top: 0.5rem!important;}

.card {position: relative;display: flex;flex-direction: column;min-width: 0;word-break: break-word;background-color: #FFF;background-clip: border-box;border: 1px solid rgba(0,0,0,.125);border-radius: 0.25em;}

h5 {font-size: 1.25rem;}

.mt-5, .my-5 {margin-top: auto;}

.d-flex {display: flex!important;}

.col-md-10 {flex: 0 0 83.333333%;max-width: 83.333333%;}

.col, .col-1, .col-10, .col-11, .col-12, .col-2, .col-3, .col-4, .col-5, .col-6, .col-7, .col-8, .col-9, .col-auto, .col-lg, .col-lg-1, .col-lg-10, .col-lg-11, .col-lg-12, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-auto, .col-md, .col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-auto, .col-sm, .col-sm-1, .col-sm-10, .col-sm-11, .col-sm-12, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-auto, .col-xl, .col-xl-1, .col-xl-10, .col-xl-11, .col-xl-12, .col-xl-2, .col-xl-3, .col-xl-4, .col-xl-5, .col-xl-6, .col-xl-7, .col-xl-8, .col-xl-9, .col-xl-auto {position: relative;
    
    padding-right: 15px;
    padding-left: 15px;}

.pb-4, .py-4 {padding-bottom: 1.5rem!important;}

.pt-4, .py-4 {padding-top: 1.5rem!important;}

.p-3 {padding: 1rem!important;}

.col-md-4 {flex: 0 0 33.333333%;
    max-width: 33.333333%;}

.dropdown, .dropleft, .dropright, .dropup {position: relative;}

.btn:not(:disabled):not(.disabled) {cursor: pointer;}

button:focus:not(:focus-visible) {outline: 0;}

.dropdown-toggle {white-space:  nowrap;}
	
element.style {
    position: absolute;
    transform: translate3d(0px, 38px, 0px);
    top: 0px;
    left: 0px;
    will-change: transform;
}
	
.btn-block {display: block;
    width: 100%;}

[type=button], [type=reset], [type=submit], button {-webkit-appearance: button;}

.dropdown-menu {position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 10rem;
    padding: 0.5rem 0;
    margin: 0.125rem 0 0;
    font-size: 1rem;
    color: #212529;
    text-align: left;
    list-style: none;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 0.25rem;}

.btn-secondary:not(:disabled):not(.disabled).active:focus, .btn-secondary:not(:disabled):not(.disabled):active:focus, .show>.btn-secondary.dropdown-toggle:focus {box-shadow: 0 0 0 0.2rem rgb(130 138 145 / 50%);}

.btn-secondary:not(:disabled):not(.disabled).active, .btn-secondary:not(:disabled):not(.disabled):active, .show>.btn-secondary.dropdown-toggle {color: #fff;
    background-color: #545b62;
    border-color: #4e555b;}

.dropdown-toggle::after {display: inline-block;}

.dropdown-toggle::after {;display: inline-block;margin-left: 0.255em;}

.dropdown, .dropleft, .dropright, .dropup {
    position: relative;
}
	
	.dropdown-menu > li > a:hover {
    background-image: none;
    background-color: F7BF50!important;
}
	
.dropdown-item {display: block;
    width: 100%;
    padding: 0.25rem 1.5rem;
    clear: both;
    font-weight: 400;
    color: #212529;
    text-align: inherit;
    white-space: nowrap;
    background-color: transparent;
    border: 0;}

.form-check-input {position: absolute;
    margin-top: 0.5rem;
    margin-left: -1.25rem;}

.form-check-label {margin-bottom: 0;}

.col-md-5 {flex: 0 0 41.666667%;max-width: 41.666667%;}

.col-md-3 {flex: 0 0 25%;
    max-width: 25%;}

	.btn, .btn:hover {
    font-weight: 600;
    font-size: 16px;
    display: inline-block;
    font-weight: 400;
    color: #212529;
	background-color: #545b62;
    text-align: center;
    vertical-align: middle;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    background-color: transparent;
    border: 1px solid transparent;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: 0.25rem;
    transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
}
	
html {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent !important;
}



    * {
        box-sizing: inherit;
    }

    .autocomplete {
        /*the container must be positioned relative:*/
        position: relative;
        display: inline-block;

    }

    input {
        border: 1px solid transparent;
        background-color: #f1f1f1;
        padding: 10px;
        font-size: 16px;
    }

	.dropdown-menu{
    	transform: translate3d(5px, 35px, 0px)!important;
	}
	
    input[type=text] {
        background-color: #f1f1f1;
        width: 100%;
    }

    input[type=submit] {
        background-color: DodgerBlue;
        color: #fff;
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 2;
        /*position the autocomplete items to be the same width as the container:*/
        top: 100%;
        left: 15px;
        right: 15px;
    }

    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
    }

    .autocomplete-items div:hover {
        /*when hovering an item:*/
        background-color: #e9e9e9;
    }

    .autocomplete-active {
        /*when navigating through the items using the arrow keys:*/
        background-color: DodgerBlue !important;
        color: #ffffff;
    }

    .container {
        width: 120%;
        z-index: -1;
        padding-right: 0px;
        padding-left: 0px;
    }
.justify-content-center {
    justify-content: left!important;
}
    body {
        background-color: #FFFFFF;
        text-transform: none;

    }

    .advanced {
        text-decoration: none;
        font-size: 15px;
        font-weight: 1000
    }

    .btn-secondary,
    .btn-secondary:focus,
    .btn-secondary:active{
        color: #000;
        background-color: #F7BF50 !important;
        border-color: #F7BF50 !important;
        box-shadow: none
    }
	
	.btn-secondary:hover{
        color: #FFF;
        background-color: #F7BF50 !important;
        border-color: #F7BF50 !important;
        box-shadow: none
    }

    .advanced {
        color: #F7BF50 !important
		hover: #F7BF50
    }

    .form-control:focus {
        box-shadow: none;
        border: 1px solid #F7BF50
    }
    .form-control{
        left:100px;
    }

    body {
        margin: 0;
        padding: 0;
    }

    #map {
        width: 100%;
        height: 60vh;
        z-index: 1;
    }

    span {
        text-transform: none;
    }

    .loading-overlay {
        width: 96.6%;
        height: 60vh;
        background-color: #d4d4d4;
        opacity: 0.7;
        z-index: 2;
        position: absolute;
        margin: auto;
        top:122px;
        bottom: 0;
        left: 0;
        right: 0;
        }

    .hidden {
        display: none;
    }

    .dropdown-menu.show {
    right: 0;
  }
    .btn, .btn:hover {
        font-weight: 600;
        font-size:16px;
    }

    .spinner-border{
        position: absolute;
        margin: auto;
        top:0;
        bottom: 0;
        left: 0;
        right: 0;
    }



</style>


<body>
    <div>
        <div class="container mt-5">
            <div class="row d-flex justify-content-center">
                <div class="col-md-10">
                    <div class="card p-3 py-4">
                        <h5>An Easier Way To Find Your Local Community</h5>
                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <div class="dropdown" data-display="static"> <button class="btn btn-secondary btn-block dropdown-toggle"
                                        type="button" id="dropdownMenuButton" data-toggle="dropdown"
                                        aria-expanded="false"> Places Of
                                        Interest ▼ </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        <div id="all">
                                            <a class="dropdown-item" href="#">
                                                <input
                                                    onclick="setAllCheckboxes('amenities', this);checkAllCheckboxes('all', this);"
                                                    class="form-check-input" type="checkbox" value="" id="flexCheckAll">
                                                <label class="form-check-label" for="flexCheckAll"><b>
                                                    All
													</b></label></a>
                                            <div id="amenities">

                                                <a class="dropdown-item" href="#">
                                                    <input
                                                        onclick="setAllCheckboxes('placesOfWorship', this);checkAllCheckboxes('all', this);"
                                                        class="form-check-input" type="checkbox" value=""
                                                        id="flexCheckPlacesOfWorship">
                                                    <label class="form-check-label" for="flexCheckPlacesOfWorship"><b>
                                                        Places of Worship
														</b></label>
                                                </a>
                                                <div id="placesOfWorship">
                                                    <a class="dropdown-item" href="#">
                                                        <input onclick="checkAllCheckboxes('all', this);"
                                                            class="col-sm-1" type="checkbox" value=""
                                                            id="flexCheckChristian">
                                                        <label class="form-check-label" for="flexCheckChristian">
                                                            Christian
                                                        </label>
                                                    </a>
                                                    <a class="dropdown-item">
                                                        <input onclick="checkAllCheckboxes('all', this);"
                                                            class="col-sm-1" type="checkbox" value=""
                                                            id="flexCheckMuslim">
                                                        <label class="form-check-label" for="flexCheckMuslim">
                                                            Muslim
                                                        </label>
                                                    </a>
                                                    <a class="dropdown-item">
                                                        <input onclick="checkAllCheckboxes('all', this);"
                                                            class="col-sm-1" type="checkbox" value=""
                                                            id="flexCheckBuddhist">
                                                        <label class="form-check-label" for="flexCheckBuddhist">
                                                            Buddhist
                                                        </label>
                                                    </a>
                                                    <a class="dropdown-item" href="#">
                                                        <input onclick="checkAllCheckboxes('all', this);"
                                                            class="col-sm-1" type="checkbox" value=""
                                                            id="flexCheckHindu">
                                                        <label class="form-check-label" for="flexCheckHindu">
                                                            Hindu
                                                        </label>
                                                    </a>
                                                    <a class="dropdown-item" href="#">
                                                        <input onclick="checkAllCheckboxes('all', this);"
                                                            class="col-sm-1" type="checkbox" value=""
                                                            id="flexCheckJewish">
                                                        <label class="form-check-label" for="flexCheckJewish">
                                                            Jewish
                                                        </label>
                                                    </a>

                                                    <a class="dropdown-item" href="#">
                                                        <input onclick="checkAllCheckboxes('all', this);"
                                                            class="col-sm-1" type="checkbox" value=""
                                                            id="flexCheckOther">
                                                        <label class="form-check-label" for="flexCheckOther">
                                                            Other
                                                        </label>
                                                    </a>
                                                </div>
                                                <a class="dropdown-item" href="#">
                                                    <input onclick="checkAllCheckboxes('all', this);"
                                                        class="form-check-input" type="checkbox" value=""
                                                        id="flexCheckCommunityCentres">
                                                    <label class="form-check-label" for="flexCheckCommunityCentres"><b>
                                                        Community Centres
														</b></label></a>
												<a class="dropdown-item" href="#">
                                                    <input
                                                        onclick="setAllCheckboxes('foodDrinks', this);checkAllCheckboxes('all', this);"
                                                        class="form-check-input" type="checkbox" value=""
                                                        id="flexCheckFoodDrinks">
                                                    <label class="form-check-label" for="flexCheckFoodDrinks"><b>
                                                        Food and Drinks
														</b></label>
                                                </a>
												    <div id="foodDrinks">
                                                        <a class="dropdown-item" href="#">
                                                            <input onclick="checkAllCheckboxes('all', this);"
                                                                class="col-sm-1" type="checkbox" value=""
                                                                id="flexCheckrestaurant">
                                                            <label class="form-check-label" for="flexCheckrestaurant">
                                                                Restaurants
                                                            </label>
                                                        </a>
                                                        <a class="dropdown-item">
                                                            <input onclick="checkAllCheckboxes('all', this);"
                                                                class="col-sm-1" type="checkbox" value=""
                                                                id="flexCheckcafe">
                                                            <label class="form-check-label" for="flexCheckcafe">
                                                                Cafes
                                                            </label>
                                                        </a>
                                                        <a class="dropdown-item">
                                                            <input onclick="checkAllCheckboxes('all', this);"
                                                                class="col-sm-1" type="checkbox" value=""
                                                                id="flexCheckbar">
                                                            <label class="form-check-label" for="flexCheckbar">
                                                                Bars
                                                            </label>
                                                        </a>
                                                        <a class="dropdown-item" href="#">
                                                            <input onclick="checkAllCheckboxes('all', this);"
                                                                class="col-sm-1" type="checkbox" value=""
                                                                id="flexCheckpub">
                                                            <label class="form-check-label" for="flexCheckpub">
                                                                Pubs
                                                            </label>
                                                        </a>
                                                    </div>
                                                    <a class="dropdown-item" href="#">
                                                        <input
                                                            onclick="setAllCheckboxes('schools', this);checkAllCheckboxes('all', this);"
                                                            class="form-check-input" type="checkbox" value=""
                                                            id="flexCheckSchools">
                                                        <label class="form-check-label" for="flexCheckSchools"><b>
                                                            Schools
                                                            </b></label>
                                                    </a>
                                            </div>
                                        </div>
                                    </ul>

                                </div>
                            </div>
                            <form autocomplete="off" action="/action_page.php"></form>
                            <div class="col-md-5"> <input type="text" id="myInput" class="form-control" autocomplete="off"
                                    placeholder="Enter suburb..."> </div>
                            <div class="col-md-3"> <button class="btn btn-secondary btn-block" id="searchButton"
                                    onclick="onSearchResultsClick()">Search Results</button>
                            </div>

                        </div>
                        <br>
                        <div class="parent">
                            <div id="map"></div>
                            <div class="loading-overlay hidden">
                                <div class="spinner-border" style="width: 7rem; height: 7rem;">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <ul id="postcodeList"></ul>
        </div>
</body>

<script>

     let initCoords = [-27.923236757216692, 133.54247957468033]

    var layerLookup = {};
    var initMarker;

    var map = L.map('map').setView(initCoords, 5);
    var info;
    var postcodeInfo;
    map.zoomControl.setPosition('topright');

    layerLookup['search'] = L.layerGroup().addTo(map);


    navigator.geolocation.getCurrentPosition(position => {
        initCoords = [position.coords.latitude, position.coords.longitude]
        map.setView(initCoords, 14)
        initMarker = L.marker([initCoords[0], initCoords[1]], {
                icon: locationMarker
            })
            .addTo(layerLookup['search']);
    });

    var poiData, postcodeData;

    var locality = 'hall';

    async function getPOIData(north,south,east,west) {

        const loadingOverlay = document.getElementsByClassName('loading-overlay')?.[0];

        const res = await fetch(`https://d8ecgfo964.execute-api.ap-southeast-2.amazonaws.com/default/mysql_query?south=${south}&north=${north}&east=${east}&west=${west}`);
        const json = await res.json();

        var layerLookup = {};

        return json;
    }

    async function getPostcodeData(locality) {

        const loadingOverlay = document.getElementsByClassName('loading-overlay')?.[0];

        const res = await fetch(
            `https://cjrfnta8ve.execute-api.ap-southeast-2.amazonaws.com/default/mysql_postcode_query?locality=${locality}`
            );
        const json = await res.json();

        return json;
    }

    function onSearchResultsClick() {
        arr = {};

        val = document.getElementById("myInput").value.split(', ')[0]

        if (val.length >= 3) {
            postcodeDict = getPostcodeData(val)
        } else {
            postcodeDict = getPostcodeData('madting')
        }

        postcodeDict.then(function (result) {

            postcodeDict = result


            for (var i = 0; i < postcodeDict.length; i++) {
                arr[postcodeDict[i].locality.toString() + ', ' + postcodeDict[i].state.toString() + ', ' +
                    postcodeDict[i].postcode.toString()] = [postcodeDict[i].lon, postcodeDict[i].lat];

            }
            return arr
        }).then(arr => {

            input = document.getElementById("myInput").value
            inputLocality = input.split(', ')[0]
            inputState = input.split(', ')[1]
            inputPostcode = input.split(', ')[2]

            layerLookup['search'] = L.layerGroup().addTo(map);

            Object.entries(arr).forEach(([key, value]) => {
                searchLocality = key.split(', ')[0]
                searchState = key.split(', ')[1]
                searchPostcode = key.split(', ')[2]

                if (searchPostcode == inputPostcode) {
                    if (searchLocality == inputLocality) {
                        if (layerLookup.length != 0) {
                            var count = 0;
                            map.eachLayer((layer) => {
                                if (layer instanceof L.Marker) {
                                    if (layer._icon.className ==
                                        'awesome-marker-icon-red awesome-marker leaflet-zoom-animated leaflet-interactive'
                                        ) {
                                        if (layer._latlng.lat == value[1]) {
                                            if (count == 0) {
                                                count += 1
                                            } else {
                                                layer.remove()
                                            }
                                        } else {
                                            layer.remove()
                                        }
                                    }
                                }
                            })
                        }

                        map.setView([value[1], value[0]], 14)

                        marker = L.marker([value[1], value[0]], {
                                icon: locationMarker
                            })
                            .addTo(layerLookup['search']);
                    }
                }
            })
        })
    }

    // search functionality based on 
    function searchFunction() {
        var postcodes;

        function autocomplete(input, arr) {
            arr = {};

            /*the autocomplete function takes two arguments,
            the text field element and an array of possible autocompleted values:*/
            var currentFocus;
            /*execute a function when someone writes in the text field:*/
            input.addEventListener("input", function (e) {

                arr = {};
                var count = 0;
                var a, b, i, val = this.value;


                if (val.length >= 3) {
                    postcodeDict = getPostcodeData(val)
                } else {
                    postcodeDict = getPostcodeData('madting')
                }


                postcodeDict.then(function (result) {
                    postcodeDict = result

                    for (var i = 0; i < postcodeDict.length; i++) {
                        arr[postcodeDict[i].locality.toString() + ', ' + postcodeDict[i].state
                        .toString() + ', ' + postcodeDict[i].postcode.toString()] = [postcodeDict[i]
                            .lon, postcodeDict[i].lat
                        ];

                    }


                    return arr
                }).then(arr => {
                    /*close any already open lists of autocompleted values*/
                    closeAllLists();
                    if (!val) {
                        return false;
                    }
                    currentFocus = -1;
                    /*create a DIV element that will contain the items (values):*/
                    a = document.createElement("DIV");
                    a.setAttribute("id", this.id + "autocomplete-list");
                    a.setAttribute("class", "autocomplete-items");
                    /*append the DIV element as a child of the autocomplete container:*/
                    this.parentNode.appendChild(a);
                    /*for each item in the array...*/



                    Object.entries(arr).forEach(([key, value]) => {
                        /*check if the item starts with the same letters as the text field value:*/
                        if (count < 11) {
                            if (key.substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                                count += 1
                                /*create a DIV element for each matching element:*/
                                b = document.createElement("DIV");
                                b.className = 'form-control';

                                /*make the matching letters bold:*/
                                b.innerHTML = "<strong>" + key.substr(0, val.length) +
                                    "</strong>";
                                b.innerHTML += key.substr(val.length);
                                /*insert a input field that will hold the current array item's value:*/
                                b.innerHTML += "<input type='hidden' value='" + key + "'>";
                                /*execute a function when someone clicks on the item value (DIV element):*/
                                b.addEventListener("click", function (e) {
                                    /*insert the value for the autocomplete text field:*/
                                    input.value = this.getElementsByTagName("input")[0]
                                        .value;
                                    /*close the list of autocompleted values,
                                    (or any other open lists of autocompleted values:*/
                                    closeAllLists();
                                });
                                a.appendChild(b);
                            }
                        }

                        if (i == arr.length - 1) {
                            if (count == 0) {

                                count += 1
                                /*create a DIV element for each matching element:*/
                                b = document.createElement("DIV");
                                b.className = 'form-control';

                                /*make the matching letters bold:*/
                                b.innerHTML = "No results found";

                                /*execute a function when someone clicks on the item value (DIV element):*/
                                b.addEventListener("click", function (e) {
                                    /*insert the value for the autocomplete text field:*/
                                    input.value = this.getElementsByTagName("input")[0]
                                        .value;
                                    /*close the list of autocompleted values,
                                    (or any other open lists of autocompleted values:*/
                                    closeAllLists();
                                });
                                a.appendChild(b);
                            }
                        }
                    });
                })


            });

            /*execute a function presses a key on the keyboard:*/
            input.addEventListener("keydown", function (e) {
                
                val = document.getElementById("myInput").value

                if (val.length >= 3) {
                    postcodeDict = getPostcodeData(val)
                } else {
                    postcodeDict = getPostcodeData('madting')
                }


                postcodeDict.then(function (result) {

                    postcodeDict = result

                    onSearchResultsClick()


                })
            });

            input.addEventListener("keydown", function (e) {
                var x = document.getElementById(this.id + "autocomplete-list");
                        if (x) x = x.getElementsByTagName("div");
                        if (e.keyCode == 40) {
                            /*If the arrow DOWN key is pressed,
                            increase the currentFocus variable:*/
                            currentFocus++;
                            /*and and make the current item more visible:*/
                            addActive(x);
                            
                        } else if (e.keyCode == 38) { //up
                            /*If the arrow UP key is pressed,
                            decrease the currentFocus variable:*/
                            currentFocus--;
                            /*and and make the current item more visible:*/
                            addActive(x);
                        } else if (e.keyCode == 13) {
                            /*If the ENTER key is pressed, prevent the form from being submitted,*/
                            e.preventDefault();
                            if (currentFocus > -1) {
                                /*and simulate a click on the "active" item:*/
                                if (x) x[currentFocus].click();
                            }
                        }
                    })

            function addActive(x) {
                /*a function to classify an item as "active":*/
                if (!x) return false;
                /*start by removing the "active" class on all items:*/
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                /*add class "autocomplete-active":*/
                x[currentFocus].classList.add("autocomplete-active");
                
            }

            function removeActive(x) {
                /*a function to remove the "active" class from all autocomplete items:*/
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
            
            function closeAllLists(elmnt) {
                /*close all autocomplete lists in the document,
                except the one passed as an argument:*/
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i]) {
                        if (elmnt != input) {
                            x[i].parentNode.removeChild(x[i]);
                        }
                    }
                }
            }
            /*execute a function when someone clicks in the document:*/
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }


        autocomplete(document.getElementById("myInput"), postcodes);

    }

    searchFunction()

    function setAllCheckboxes(divId, sourceCheckbox) {
        divElement = document.getElementById(divId);
        inputElements = divElement.getElementsByTagName('input')

        for (i = 0; i < inputElements.length; i++) {
            inputElements[i].checked = sourceCheckbox.checked;
        }

    }

    function checkAllCheckboxes(divId, sourceCheckbox) {
        map.setView(map.getCenter())
        divElement = document.getElementById(divId);
        inputElements = divElement.getElementsByTagName('input')

        countWorship = 0;
        countAll = 0;
        countFoodDrink = 0;

        for (i = 10; i < 14; i++) {
            if (inputElements[i].checked == true) {
                countFoodDrink += 1;
            }
        }

        for (i = 0; i < inputElements.length; i++) {
            
            if (inputElements[i].id == 'flexCheckFoodDrinks') {
                if (countFoodDrink == 0) {
                    inputElements[i].checked = false
                    inputElements[i].indeterminate = false
                } else if (countFoodDrink == 4) {
                    inputElements[i].checked = true
                    inputElements[i].indeterminate = false
                } else {
                    inputElements[i].checked = false
                    inputElements[i].indeterminate = true
                }
            }
        }

        for (i = 2; i < 8; i++) {
            if (inputElements[i].checked == true) {
                countWorship += 1;
            }
        }

        for (i = 0; i < inputElements.length; i++) {
            if (inputElements[i].id == 'flexCheckPlacesOfWorship') {
                if (countWorship == 0) {
                    inputElements[i].checked = false
                    inputElements[i].indeterminate = false
                } else if (countWorship == 6) {
                    inputElements[i].checked = true
                    inputElements[i].indeterminate = false
                } else {
                    inputElements[i].checked = false
                    inputElements[i].indeterminate = true
                }
            }
        }
        for (i = 1; i < 14; i++) {
            if (inputElements[i].checked == true) {
                countAll += 1;
            }

        }

        for (i = 0; i < inputElements.length; i++) {
            if (inputElements[i].id == 'flexCheckAll') {
                if (countAll == 0) {
                    inputElements[i].checked = false
                    inputElements[i].indeterminate = false
                } else if (countAll == 13) {
                    inputElements[i].checked = true
                    inputElements[i].indeterminate = false
                } else {
                    inputElements[i].checked = false
                    inputElements[i].indeterminate = true
                }
            }
        }
    }



    var locationMarker = L.AwesomeMarkers.icon({
        icon: 'location',
        iconColor: 'darkred',
        prefix: 'fa',
        markerColor: 'red'
    });

    var christianMarker = L.AwesomeMarkers.icon({
        icon: 'cross',
        iconColor: '#0D628D',
        prefix: 'fa',
        markerColor: 'blue'
    });

    var muslimMarker = L.AwesomeMarkers.icon({
        icon: 'mosque',
        iconColor: '#0D628D',
        prefix: 'fa',
        markerColor: 'blue'
    });

    var buddhistMarker = L.AwesomeMarkers.icon({
        icon: 'dharmachakra',
        iconColor: '#0D628D',
        prefix: 'fa',
        markerColor: 'blue'
    });

    var hinduMarker = L.AwesomeMarkers.icon({
        icon: 'gopuram',
        iconColor: '#0D628D',
        prefix: 'fa',
        markerColor: 'blue'
    });

    var jewishMarker = L.AwesomeMarkers.icon({
        icon: 'star-of-david',
        iconColor: '#0D628D',
        prefix: 'fa',
        markerColor: 'blue'
    });

    var worshipMarker = L.AwesomeMarkers.icon({
        icon: 'pray',
        iconColor: '#0D628D',
        prefix: 'fa',
        markerColor: 'blue'
    });

    var communityMarker = L.AwesomeMarkers.icon({
        icon: 'school',
        iconColor: '#136D06',
        prefix: 'fa',
        markerColor: 'green'
    });

    var restaurantMarker = L.AwesomeMarkers.icon({
        icon: 'utensil-fork',
        iconColor: '#84540B',
        prefix: 'fa',
        markerColor: 'orange'
    });

    var cafeMarker = L.AwesomeMarkers.icon({
        icon: 'mug-hot',
        iconColor: '#84540B',
        prefix: 'fa',
        markerColor: 'orange'
    });

    var pubMarker = L.AwesomeMarkers.icon({
        icon: 'beer',
        iconColor: '#84540B',
        prefix: 'fa',
        markerColor: 'orange'
    });

    var barMarker = L.AwesomeMarkers.icon({
        icon: 'glass-martini-alt',
        iconColor: '#84540B',
        prefix: 'fa',
        markerColor: 'orange'
    });

    function updateMarkers(divId) {
        markerList = []
        divElement = document.getElementById(divId);
        inputElements = divElement.getElementsByTagName('input')

        for (i = 0; i < inputElements.length; i++) {
            if (inputElements[i].checked == true) {
                markerList.push(inputElements[i].id)
            }
        }
        markerList.push('search')
        return (markerList)
    }

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        minZoom: 13
    }).addTo(map);


    map.on('moveend', onMoveEnd);



    function createWorshipPopup(el) {
        return `
            <b style="font-size:14px">${el.name}</b>
            <br/>
            <br/>
            <b>Religion:</b> ${el.type}
            <br/>
            <b>Denomination:</b> ${el.subtype}
            `;
    }

    function createFoodDrinkPopup(el) {
        if (el.type != ''){
            if (el.subtype != ''){
                return `
                <b style="font-size:14px">${el.name}</b>
                <br/>
                <br/>
                <b>Cuisine:</b> ${el.type}
                <br/>
                <b>Diet:</b> ${el.subtype}`;
            }
            else {
                return `
                <b style="font-size:14px">${el.name}</b>
                <br/>
                <br/>
                <b>Cuisine:</b> ${el.type}`;
            }
        }
        else{
            return `<b style="font-size:14px">${el.name}</b>`;
        }
        
    }


    const religions = [
        'Christian',
        'Muslim',
        'Buddhist',
        'Hindu',
        'Jewish',
        'Other'
    ]

    const foodDrinks = [
        'restaurant',
        'cafe',
        'bar',
        'pub'
    ]

    const religionIconMap = {
        'Christian': christianMarker,
        'Muslim': muslimMarker,
        'Buddhist': buddhistMarker,
        'Hindu': hinduMarker,
        'Jewish': jewishMarker,
        'Other:': worshipMarker
    }

    const foodDrinksIconMap = {
        'restaurant': restaurantMarker,
        'cafe': cafeMarker,
        'bar': barMarker,
        'pub': pubMarker

    }

    function onMoveEnd(event) {
        let bounds;

        if (!!event) {
            bounds = event.target.getBounds();
        } else {
            bounds = map.getBounds();
        }

        divElement = document.getElementById('all');
        inputElements = divElement.getElementsByTagName('input')


        const data = getPOIData(bounds.getNorth(),bounds.getSouth(),bounds.getEast(),bounds.getWest());
        var poiData;
        
        data.then(function (result) {
            info = result

            if (layerLookup.length != 0) {
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        if (layer._icon.className ==
                            'awesome-marker-icon-red awesome-marker leaflet-zoom-animated leaflet-interactive'
                            ) {

                        } else {

                            if (layer._latlng != undefined) {
                                layer.remove();
                            }
                        }
                    }
                })
            }

            ting = updateMarkers('all');

            for (var i = 0; i < ting.length; i++) {
                layerLookup[ting[i]] = L.layerGroup().addTo(map);
            }

            if (Object.keys(layerLookup).length != 0) {
                for (var i = 0; i < info.length; i++) {
                    if (info[i].amenity == 'place_of_worship') {
                        for (var j = 0; j < religions.length; j++) {
                            const religion = religions[j];

                            if (info[i].type == religion) {
                                if (Object.keys(layerLookup).includes(`flexCheck${religion}`)) {
                                    marker = L.marker([info[i].lat, info[i].lon], {
                                            icon: religionIconMap[religion]
                                        })
                                        .bindPopup(createWorshipPopup(info[i]))
                                        .addTo(layerLookup[`flexCheck${religion}`]);
                                }
                            }
                        }

                    } else if (info[i].amenity == 'community_centre') {
                        if (Object.keys(layerLookup).includes("flexCheckCommunityCentres")) {
                            marker = L.marker([info[i].lat, info[i].lon], {
                                    icon: communityMarker
                                })
                                .bindPopup('<b style="font-size:14px">' + info[i].name)
                                .addTo(
                                    layerLookup[
                                        "flexCheckCommunityCentres"]);
                        }
                    } else {
                        for (var j = 0; j < foodDrinks.length; j++) {
                            
                            const foodDrink = foodDrinks[j];


                            if (info[i].amenity == foodDrink) {
                                if (Object.keys(layerLookup).includes(`flexCheck${foodDrink}`)) {
                                    marker = L.marker([info[i].lat, info[i].lon], {
                                            icon: foodDrinksIconMap[foodDrink]
                                        })
                                        .bindPopup(createFoodDrinkPopup(info[i]))
                                        .addTo(layerLookup[`flexCheck${foodDrink}`]);
                                }
                            }
                        }
                    }
                }
            }
            layerLookup = {};
        })
    }
</script>